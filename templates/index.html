<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>試劑入庫管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 20px;
            padding: 30px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            border: none;
            border-radius: 25px;
            padding: 8px 20px;
        }
        .btn-warning {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            border: none;
            border-radius: 25px;
            padding: 8px 20px;
        }
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .table {
            border-radius: 15px;
            overflow: hidden;
        }
        .table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-weight: 600;
        }
        .alert {
            border-radius: 15px;
            border: none;
        }
        .modal-content {
            border-radius: 20px;
            border: none;
        }
        .search-box {
            position: relative;
        }
        .search-box .form-control {
            padding-right: 50px;
        }
        .search-box .btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }
        .batch-new {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .batch-old {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .nav-tabs {
            border: none;
            margin-bottom: 30px;
        }
        .nav-tabs .nav-link {
            border: none;
            border-radius: 15px 15px 0 0;
            margin-right: 10px;
            padding: 15px 30px;
            font-weight: 600;
            color: #6c757d;
            background: rgba(108, 117, 125, 0.1);
            transition: all 0.3s ease;
        }
        .nav-tabs .nav-link:hover {
            background: rgba(108, 117, 125, 0.2);
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .tab-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* 自動完成樣式 */
        .suggestion-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa !important;
        }
        
        .suggestion-item.bg-primary:hover {
            background-color: #0056b3 !important;
        }
        
        #reagentSuggestions {
            border-top: none !important;
            border-radius: 0 0 0.375rem 0.375rem !important;
            border-color: #dee2e6;
        }
        
        #reagentName:focus + #reagentSuggestions {
            border-color: #86b7fe;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }

        /* 智能表單填充樣式 */
        .auto-filled {
            background-color: #e8f5e8 !important;
            border-color: #28a745 !important;
        }

        .auto-suggested {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
        }

        input[readonly].auto-filled {
            background-color: #e8f5e8 !important;
            cursor: not-allowed;
        }

        .auto-fill-notification {
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }

        /* 批號建議框樣式 */
        #batchSuggestions {
            border-top: none !important;
            border-radius: 0 0 0.375rem 0.375rem !important;
            border-color: #dee2e6;
        }

        #reagentBatchNumber:focus + #batchSuggestions {
            border-color: #86b7fe;
        }

        #batchSuggestions .suggestion-item {
            border-color: #dee2e6;
        }

        #batchSuggestions .suggestion-item:hover {
            background-color: #f8f9fa !important;
        }

        #batchSuggestions .suggestion-item.bg-primary:hover {
            background-color: #0056b3 !important;
        }

    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
        <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary mb-3">
                    <i class="fas fa-flask me-3"></i>試劑入庫管理系統
            </h1>
                <p class="lead text-muted">專業的試劑庫存管理解決方案</p>
        </div>

            <!-- 頁籤導航 -->
            <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="entry-tab" data-bs-toggle="tab" data-bs-target="#entry" type="button" role="tab">
                        <i class="fas fa-plus-circle me-2"></i>新增入庫
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="search-records-tab" data-bs-toggle="tab" data-bs-target="#search-records" type="button" role="tab">
                        <i class="fas fa-search me-2"></i>搜尋與紀錄
                    </button>
                </li>
            </ul>

            <!-- 頁籤內容 -->
            <div class="tab-content" id="mainTabsContent">
                <!-- 新增入庫頁籤 -->
                <div class="tab-pane fade show active" id="entry" role="tabpanel">
        <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>新增入庫資料</h5>
            </div>
                        <div class="card-body">
                                                         <form id="entryForm">
                                 <div class="row">
                                     <div class="col-md-6 mb-3">
                                         <label for="reagentName" class="form-label fw-bold">試劑名稱 *</label>
                                         <div class="position-relative">
                                             <input type="text" class="form-control" id="reagentName" required 
                                                    autocomplete="off" placeholder="輸入試劑名稱...">
                                             <div id="reagentSuggestions" class="position-absolute w-100 bg-white border border-top-0 rounded-bottom shadow-sm" 
                                                  style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                                     <div class="col-md-6 mb-3">
                                         <label for="reagentBatchNumber" class="form-label fw-bold">試劑批號 *</label>
                                        <div class="position-relative">
                                            <input type="text" class="form-control" id="reagentBatchNumber" required
                                                   autocomplete="off" placeholder="輸入試劑批號...">
                                            <div id="batchSuggestions" class="position-absolute w-100 bg-white border border-top-0 rounded-bottom shadow-sm" 
                                                 style="display: none; z-index: 999; max-height: 150px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                    </div>
                                 <div class="row">
                                     <div class="col-md-6 mb-3">
                                         <label for="expiryDate" class="form-label fw-bold">穩定效期 *</label>
                                         <input type="date" class="form-control" id="expiryDate" required>
                                </div>
                                     <div class="col-md-6 mb-3">
                                         <label for="quantity" class="form-label fw-bold">入庫數量 *</label>
                                         <input type="number" class="form-control" id="quantity" min="1" required>
                            </div>
                        </div>
                                 <div class="row">
                                     <div class="col-md-6 mb-3">
                                         <label for="unit" class="form-label fw-bold">單位 *</label>
                                         <select class="form-control" id="unit" required onchange="handleUnitChange()">
                                             <option value="">請選擇單位</option>
                                             <option value="箱">箱</option>
                                             <option value="盒">盒</option>
                                             <option value="瓶">瓶</option>
                                             <option value="組">組</option>
                                             <option value="其他">其他</option>
                                         </select>
                                         <input type="text" class="form-control mt-2" id="unitOther" placeholder="請輸入其他單位" style="display: none;">
                                </div>
                                     <div class="col-md-6 mb-3">
                                         <label for="supplier" class="form-label fw-bold">供應商 *</label>
                                         <select class="form-control" id="supplier" required onchange="handleSupplierChange()">
                                             <option value="">請選擇供應商</option>
                                             <option value="醫全">醫全</option>
                                             <option value="亞培">亞培</option>
                                             <option value="希森美康">希森美康</option>
                                             <option value="沃芬">沃芬</option>
                                             <option value="其他">其他</option>
                                         </select>
                                         <input type="text" class="form-control mt-2" id="supplierOther" placeholder="請輸入其他供應商" style="display: none;">
                            </div>
                                                                 </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="printerType" class="form-label fw-bold">標籤機類型 *</label>
                                        <select class="form-control" id="printerType" required>
                                            <option value="zpl">【大標籤機(ZPL模式)】</option>
                                            <option value="pdf">【小標籤機(PDF模式)】</option>
                                        </select>
                                        <div class="form-text">請選擇對應的標籤機類型</div>
                        </div>
                    </div>
                    
                               <div class="text-center">
                                   <button type="submit" class="btn btn-primary btn-lg">
                                      <i class="fas fa-save me-2"></i>儲存並自動列印標籤
                                   </button>
                               </div>
                            </form>
                        </div>
                        </div>
                    </div>
                    
                <!-- 搜尋與紀錄整合頁籤 -->
                <div class="tab-pane fade" id="search-records" role="tabpanel">
                    <!-- 篩選器區域 -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>篩選搜尋</h5>
                            <button class="btn btn-outline-light btn-sm" onclick="switchToSearchTab()" title="重新載入資料">
                                <i class="fas fa-sync-alt"></i>
                        </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label for="filterName" class="form-label fw-bold">試劑名稱</label>
                                    <input type="text" class="form-control" id="filterName" placeholder="輸入試劑名稱">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="filterBatch" class="form-label fw-bold">批號</label>
                                    <input type="text" class="form-control" id="filterBatch" placeholder="輸入批號">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="filterSupplier" class="form-label fw-bold">供應商</label>
                                    <select class="form-control" id="filterSupplier">
                                        <option value="">全部供應商</option>
                                        <option value="醫全">醫全</option>
                                        <option value="亞培">亞培</option>
                                        <option value="希森美康">希森美康</option>
                                        <option value="沃芬">沃芬</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="filterDateFrom" class="form-label fw-bold">開始日期</label>
                                    <input type="date" class="form-control" id="filterDateFrom">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="filterDateTo" class="form-label fw-bold">結束日期</label>
                                    <input type="date" class="form-control" id="filterDateTo">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3 d-flex justify-content-center">
                                    <button class="btn btn-primary me-3" onclick="applyFilters()">
                                        <i class="fas fa-filter me-2"></i>套用篩選
                        </button>
                                    <button class="btn btn-primary" onclick="clearFilters()">
                                        <i class="fas fa-times me-2"></i>清除篩選
                        </button>
                    </div>
                            </div>
            </div>
        </div>
        
                    <!-- 資料顯示區域 -->
                    <div class="card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>入庫紀錄</h5>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-light text-dark me-3" id="recordCount">共 0 筆記錄</span>
                                <button class="btn btn-outline-light btn-sm me-2" onclick="exportToCSV()">
                                    <i class="fas fa-download me-1"></i>匯出
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="showImportModal()">
                                    <i class="fas fa-upload me-1"></i>匯入
                                </button>
            </div>
                        </div>
                        <div class="card-body">
                <div class="table-responsive">
                                <table class="table table-hover">
                        <thead>
                            <tr>
                                            <th>試劑名稱</th>
                                            <th>試劑批號</th>
                                            <th>穩定效期</th>
                                            <th>數量</th>
                                            <th>單位</th>
                                            <th>供應商</th>
                                            <th>入庫日期</th>
                                            <th>操作</th>
                            </tr>
                        </thead>
                                    <tbody id="entriesTableBody">
                                        <!-- 資料將由JavaScript動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>



    <!-- 成功提示模態框 -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">操作成功</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="successMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新批號確認模態框 -->
    <div class="modal fade" id="newBatchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>新批號確認
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">檢測到新批號！</h6>
                        <p id="newBatchMessage" class="mb-0"></p>
                    </div>
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">入庫資料預覽</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>試劑名稱:</strong> <span id="previewReagentName"></span></p>
                                    <p><strong>試劑批號:</strong> <span id="previewBatchNumber"></span></p>
                                    <p><strong>穩定效期:</strong> <span id="previewExpiryDate"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>入庫數量:</strong> <span id="previewQuantity"></span></p>
                                    <p><strong>單位:</strong> <span id="previewUnit"></span></p>
                                    <p><strong>供應商:</strong> <span id="previewSupplier"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" onclick="confirmNewBatchEntry()">
                        <i class="fas fa-check me-2"></i>確認入庫
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 列印數量選擇器模態框 -->
    <div class="modal fade" id="printQuantityModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">📋 列印數量設定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <span class="fw-bold">試劑名稱：</span>
                        <span id="printReagentName" class="text-primary"></span>
                    </div>
                    <div class="mb-3">
                        <span class="fw-bold">入庫數量：</span>
                        <span id="printOriginalQuantity" class="text-primary"></span>
                    </div>
                    <div class="mb-3">
                        <label for="printQuantity" class="form-label fw-bold">列印數量：</label>
                        <div class="input-group">
                            <span class="fw-bold text-primary fs-5">【</span>
                            <input type="number" class="form-control text-center" id="printQuantity" min="1" max="999" style="border: none; box-shadow: none;">
                            <span class="fw-bold text-primary fs-5">】組</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="printPrinterType" class="form-label fw-bold">標籤機類型：</label>
                        <select class="form-control" id="printPrinterType" required>
                            <option value="zpl">【大標籤機(ZPL模式)】</option>
                            <option value="pdf">【小標籤機(PDF模式)】</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmPrint()">確認列印</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 匯入CSV模態框 -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-upload me-2"></i>匯入CSV檔案
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6 class="alert-heading">匯入說明</h6>
                        <ul class="mb-0">
                            <li>請選擇CSV檔案，檔案必須包含以下欄位：試劑名稱、試劑批號、穩定效期、數量、單位、供應商、入庫日期</li>
                            <li>日期格式支援：YYYY-MM-DD 或 YYYY/MM/DD</li>
                            <li>入庫日期格式支援：YYYY-MM-DD HH:MM:SS 或 YYYY/MM/DD</li>
                            <li>如果試劑名稱和批號已存在，系統會更新該筆記錄</li>
                            <li>支援UTF-8編碼的CSV檔案</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">選擇CSV檔案</label>
                        <input type="file" class="form-control" id="csvFile" accept=".csv" onchange="validateFile()">
                        <div class="form-text">支援的檔案格式：CSV</div>
                    </div>

                    <div class="mb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="downloadTemplate()">
                            <i class="fas fa-download me-1"></i>下載CSV範本
                        </button>
                    </div>

                    <div id="importProgress" class="d-none">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                        <p class="text-center">正在處理檔案，請稍候...</p>
                    </div>

                    <div id="importResult" class="d-none">
                        <!-- 匯入結果將在這裡顯示 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="importBtn" onclick="importCSV()" disabled>
                        <i class="fas fa-upload me-2"></i>開始匯入
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
        let allEntries = [];

        // 頁面載入時獲取所有記錄
document.addEventListener('DOMContentLoaded', function() {
            loadEntries();
            initializeAutocomplete();
        });

        // 自動完成功能變數
        let currentSuggestions = [];
        let selectedSuggestionIndex = -1;
        let suggestionTimeout;
        
        // 批號自動完成變數
        let currentBatchSuggestions = [];
        let selectedBatchSuggestionIndex = -1;
        let batchSuggestionTimeout;

        // 初始化自動完成功能
        function initializeAutocomplete() {
            const reagentInput = document.getElementById('reagentName');
            const suggestionsDiv = document.getElementById('reagentSuggestions');
            
            if (!reagentInput || !suggestionsDiv) {
                console.error('找不到試劑名稱輸入欄位或建議區域');
                return;
            }
            
            // 輸入事件
            reagentInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                // 清除之前的延遲
                clearTimeout(suggestionTimeout);
                
                if (query.length === 0) {
                    hideSuggestions();
                    return;
                }
                
                // 延遲搜尋，避免過於頻繁的請求
                suggestionTimeout = setTimeout(() => {
                    fetchSuggestions(query);
                }, 300);
            });
            
            // 鍵盤導航
            reagentInput.addEventListener('keydown', function(e) {
                const suggestionsDiv = document.getElementById('reagentSuggestions');
                const isVisible = suggestionsDiv.style.display !== 'none';
                
                if (!isVisible) return;
                
                switch(e.key) {
                    case 'ArrowDown':
        e.preventDefault();
                        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, currentSuggestions.length - 1);
                        updateSuggestionSelection();
                        break;
                        
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                        updateSuggestionSelection();
                        break;
                        
                    case 'Enter':
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0) {
                            selectSuggestion(currentSuggestions[selectedSuggestionIndex]);
                        }
                        break;
                        
                    case 'Escape':
                        e.preventDefault();
                        hideSuggestions();
                        break;
                }
            });
            
            // 失去焦點時隱藏建議
            reagentInput.addEventListener('blur', function() {
                // 延遲隱藏，讓點擊事件有時間觸發
                setTimeout(hideSuggestions, 200);
            });
            
            // 新增：試劑名稱變更時自動填充供應商
            reagentInput.addEventListener('change', function(e) {
                const reagentName = e.target.value.trim();
                if (reagentName) {
                    loadReagentSupplier(reagentName);
                }
            });
            
            // 新增：初始化批號自動完成
            initializeBatchAutocomplete();
        }

        // 初始化批號自動完成功能
        function initializeBatchAutocomplete() {
            const batchInput = document.getElementById('reagentBatchNumber');
            const batchSuggestionsDiv = document.getElementById('batchSuggestions');
            
            if (!batchInput || !batchSuggestionsDiv) {
                console.error('找不到批號輸入欄位或建議區域');
                return;
            }
            
            // 批號輸入事件
            batchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                const reagentName = document.getElementById('reagentName').value.trim();
                
                clearTimeout(batchSuggestionTimeout);
                
                if (query.length === 0 || !reagentName) {
                    hideBatchSuggestions();
                    clearExpiryDate();
                    return;
                }
                
                batchSuggestionTimeout = setTimeout(() => {
                    fetchBatchSuggestions(reagentName, query);
                }, 300);
            });
            
            // 批號鍵盤事件
            batchInput.addEventListener('keydown', function(e) {
                if (currentBatchSuggestions.length === 0) return;
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedBatchSuggestionIndex = Math.min(selectedBatchSuggestionIndex + 1, currentBatchSuggestions.length - 1);
                        updateBatchSuggestionSelection();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedBatchSuggestionIndex = Math.max(selectedBatchSuggestionIndex - 1, -1);
                        updateBatchSuggestionSelection();
                        break;
                    case 'Enter':
                        if (selectedBatchSuggestionIndex >= 0) {
                            e.preventDefault();
                            selectBatchSuggestion(currentBatchSuggestions[selectedBatchSuggestionIndex].batch_number);
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        hideBatchSuggestions();
                        break;
                }
            });
            
            // 批號變更時載入效期
            batchInput.addEventListener('change', function(e) {
                const batchNumber = e.target.value.trim();
                const reagentName = document.getElementById('reagentName').value.trim();
                
                if (batchNumber && reagentName) {
                    loadBatchExpiry(reagentName, batchNumber);
                }
            });
            
            // 失去焦點時隱藏批號建議
            batchInput.addEventListener('blur', function() {
                setTimeout(hideBatchSuggestions, 200);
            });
        }

        // 獲取建議
        async function fetchSuggestions(query) {
            try {
                const response = await fetch(`/api/reagent-suggestions?q=${encodeURIComponent(query)}`);
                const suggestions = await response.json();
                
                currentSuggestions = suggestions;
                selectedSuggestionIndex = -1;
                
                displaySuggestions(suggestions);
            } catch (error) {
                console.error('獲取建議失敗:', error);
                hideSuggestions();
            }
        }

        // 顯示建議
        function displaySuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('reagentSuggestions');
            
            if (suggestions.length === 0) {
                hideSuggestions();
        return;
    }
    
            const html = suggestions.map((suggestion, index) => `
                <div class="suggestion-item p-2 border-bottom cursor-pointer" 
                     data-index="${index}" 
                     onclick="selectSuggestion('${suggestion.replace(/'/g, "\\'")}')"
                     onmouseenter="highlightSuggestion(${index})">
                    <i class="fas fa-database text-success me-2"></i>${suggestion}
                </div>
            `).join('');
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
        }

        // 更新選擇的建議高亮
        function updateSuggestionSelection() {
            const items = document.querySelectorAll('.suggestion-item');
            
            items.forEach((item, index) => {
                if (index === selectedSuggestionIndex) {
                    item.classList.add('bg-primary', 'text-white');
                } else {
                    item.classList.remove('bg-primary', 'text-white');
                }
            });
        }

        // 鼠標惸停高亮
        function highlightSuggestion(index) {
            selectedSuggestionIndex = index;
            updateSuggestionSelection();
        }

        // 選擇建議
        function selectSuggestion(suggestion) {
            document.getElementById('reagentName').value = suggestion;
            hideSuggestions();
            
            // 觸發 change 事件
            document.getElementById('reagentName').dispatchEvent(new Event('change'));
        }

        // 隱藏建議
        function hideSuggestions() {
            const suggestionsDiv = document.getElementById('reagentSuggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
            currentSuggestions = [];
            selectedSuggestionIndex = -1;
        }

        // ========== 智能表單填充功能 ==========

        // 載入試劑對應的供應商和單位
        async function loadReagentSupplier(reagentName) {
            try {
                const response = await fetch(`/api/reagent-supplier?name=${encodeURIComponent(reagentName)}`);
                const data = await response.json();
                
                if (data.found) {
                    let autoFillMessages = [];
                    
                    // 自動填入供應商
                    if (data.supplier) {
                        const supplierField = document.getElementById('supplier');
                        
                        // 只在欄位為空時自動填入
                        if (!supplierField.value) {
                            supplierField.value = data.supplier;
                            supplierField.classList.add('auto-filled');
                            
                            // 如果是"其他"選項，需要觸發變更
                            if (data.supplier === '其他') {
                                handleSupplierChange();
                            }
                            
                            autoFillMessages.push(`供應商: ${data.supplier} (使用 ${data.supplier_usage_count} 次)`);
                        }
                    }
                    
                    // 自動填入單位
                    if (data.unit) {
                        const unitField = document.getElementById('unit');
                        
                        // 只在欄位為空時自動填入
                        if (!unitField.value) {
                            unitField.value = data.unit;
                            unitField.classList.add('auto-filled');
                            
                            // 如果是"其他"選項，需要觸發變更
                            if (data.unit === '其他') {
                                handleUnitChange();
                            }
                            
                            autoFillMessages.push(`單位: ${data.unit} (使用 ${data.unit_usage_count} 次)`);
                        }
                    }
                    
                    // 顯示綜合通知
                    if (autoFillMessages.length > 0) {
                        showAutoFillNotification(`✨ 已自動填入 ${autoFillMessages.join('、')}`);
                    }
                }
            } catch (error) {
                console.error('載入試劑供應商和單位失敗:', error);
            }
        }

        // 載入批號對應的效期
        async function loadBatchExpiry(reagentName, batchNumber) {
            try {
                const response = await fetch(`/api/batch-expiry?name=${encodeURIComponent(reagentName)}&batch=${encodeURIComponent(batchNumber)}`);
                const data = await response.json();
                
                const expiryField = document.getElementById('expiryDate');
                
                if (data.found && !data.is_new_batch) {
                    // 已知批號 - 自動填入效期
                    expiryField.value = data.expiry_date;
                    expiryField.classList.add('auto-filled');
                    expiryField.readOnly = true; // 鎖定欄位，因為這是歷史資料
                    
                    showAutoFillNotification(`🎯 已載入批號 "${batchNumber}" 的效期 (上次入庫: ${data.last_entry_date})`);
                    
                    // 可選：填入上次的數量和單位作為參考
                    const quantityField = document.getElementById('quantity');
                    const unitField = document.getElementById('unit');
                    
                    if (!quantityField.value) {
                        quantityField.value = data.previous_quantity;
                        quantityField.classList.add('auto-suggested');
                    }
                    
                    if (!unitField.value) {
                        unitField.value = data.previous_unit;
                        unitField.classList.add('auto-suggested');
                        handleUnitChange(); // 觸發單位變更處理
                    }
                    
                } else {
                    // 新批號 - 清空效期讓使用者輸入
                    expiryField.value = '';
                    expiryField.classList.remove('auto-filled');
                    expiryField.readOnly = false;
                    
                    if (data.is_new_batch) {
                        showNewBatchNotification(`🆕 新批號 "${batchNumber}" - 請手動輸入穩定效期`);
                    }
                }
            } catch (error) {
                console.error('載入批號效期失敗:', error);
                clearExpiryDate();
            }
        }

        // 獲取批號建議
        async function fetchBatchSuggestions(reagentName, query) {
            try {
                const response = await fetch(`/api/reagent-batches?name=${encodeURIComponent(reagentName)}`);
                const batches = await response.json();
                
                const filteredBatches = batches.filter(batch => 
                    batch.batch_number.toUpperCase().includes(query.toUpperCase())
                );
                
                currentBatchSuggestions = filteredBatches;
                selectedBatchSuggestionIndex = -1;
                displayBatchSuggestions(filteredBatches);
            } catch (error) {
                console.error('獲取批號建議失敗:', error);
                hideBatchSuggestions();
            }
        }

        // 顯示批號建議（含效期資訊）
        function displayBatchSuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('batchSuggestions');
            
            if (suggestions.length === 0) {
                hideBatchSuggestions();
        return;
    }
    
            const html = suggestions.map((batch, index) => `
                <div class="suggestion-item p-2 border-bottom cursor-pointer" 
                     data-index="${index}"
                     onclick="selectBatchSuggestion('${batch.batch_number.replace(/'/g, "\\'")}')"
                     onmouseenter="highlightBatchSuggestion(${index})">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-history text-info me-2"></i>
                            <strong>${batch.batch_number}</strong>
                        </div>
                        <small class="text-muted">效期: ${batch.expiry_date}</small>
                    </div>
                    <small class="text-muted ms-3">上次入庫: ${batch.latest_entry}</small>
                </div>
            `).join('');
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
        }

        // 更新批號建議選擇高亮
        function updateBatchSuggestionSelection() {
            const items = document.querySelectorAll('#batchSuggestions .suggestion-item');
            
            items.forEach((item, index) => {
                if (index === selectedBatchSuggestionIndex) {
                    item.classList.add('bg-primary', 'text-white');
                } else {
                    item.classList.remove('bg-primary', 'text-white');
                }
            });
        }

        // 鼠標懸停高亮批號建議
        function highlightBatchSuggestion(index) {
            selectedBatchSuggestionIndex = index;
            updateBatchSuggestionSelection();
        }

        // 選擇批號建議
        function selectBatchSuggestion(batchNumber) {
            document.getElementById('reagentBatchNumber').value = batchNumber;
            hideBatchSuggestions();
            
            // 載入該批號的詳細資料
            const reagentName = document.getElementById('reagentName').value.trim();
            if (reagentName) {
                loadBatchExpiry(reagentName, batchNumber);
            }
        }

        // 隱藏批號建議
        function hideBatchSuggestions() {
            const suggestionsDiv = document.getElementById('batchSuggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
            currentBatchSuggestions = [];
            selectedBatchSuggestionIndex = -1;
        }

        // 清空效期欄位
        function clearExpiryDate() {
            const expiryField = document.getElementById('expiryDate');
            expiryField.classList.remove('auto-filled');
            expiryField.readOnly = false;
        }

        // 顯示自動填充通知
        function showAutoFillNotification(message) {
            // 創建通知元素
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show auto-fill-notification';
            notification.innerHTML = `
                <i class="fas fa-magic me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // 插入到表單頂部
            const form = document.getElementById('entryForm');
            form.insertBefore(notification, form.firstChild);
            
            // 3秒後自動消失
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // 顯示新批號通知
        function showNewBatchNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning alert-dismissible fade show';
            notification.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const form = document.getElementById('entryForm');
            form.insertBefore(notification, form.firstChild);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // 頁籤切換時重新載入資料 - 使用多種方法確保可靠性
        function setupTabSwitching() {
            // 方法1: 直接點擊事件
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    const targetId = this.getAttribute('data-bs-target');
                    console.log('點擊頁籤:', this.id, '目標:', targetId);
                    
                    if (targetId === '#search-records') {
                        console.log('準備載入搜尋頁籤資料');
                        // 延遲一下確保頁籤切換完成後再載入資料
                        setTimeout(() => {
                            loadEntries();
                        }, 200);
                    }
                });
            });

            // 方法2: Bootstrap頁籤事件
            document.addEventListener('shown.bs.tab', function(e) {
                console.log('Bootstrap頁籤事件:', e.target.id);
                if (e.target.id === 'search-records-tab') {
                    console.log('Bootstrap: 搜尋頁籤已顯示，載入資料');
                    loadEntries();
                }
            });

            // 方法3: 手動頁籤切換函數
            window.switchToSearchTab = function() {
                console.log('手動切換到搜尋頁籤');
                const searchTab = document.getElementById('search-records-tab');
                const searchContent = document.getElementById('search-records');
                
                // 移除所有active類別
                document.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(content => {
                    content.classList.remove('show', 'active');
                });
                
                // 啟用搜尋頁籤
                searchTab.classList.add('active');
                searchContent.classList.add('show', 'active');
                
                // 載入資料
                loadEntries();
            };
        }

        // 初始化頁籤切換
        setupTabSwitching();

        // 載入入庫記錄
        async function loadEntries() {
            try {
                const response = await fetch('/api/entries');
                allEntries = await response.json();
                displayEntries(allEntries);
            } catch (error) {
                console.error('載入記錄失敗:', error);
            }
        }

                 // 顯示入庫記錄
         function displayEntries(entries) {
             const tbody = document.getElementById('entriesTableBody');
             tbody.innerHTML = '';

             // 更新記錄數量
             document.getElementById('recordCount').textContent = `共 ${entries.length} 筆記錄`;

             if (entries.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">沒有找到符合條件的記錄</td></tr>';
        return;
    }
    
             entries.forEach(entry => {
                 const row = document.createElement('tr');

                 row.innerHTML = `
                     <td>${entry.reagent_name}</td>
                     <td><strong>${entry.reagent_batch_number}</strong></td>
                     <td>${entry.expiry_date}</td>
                     <td><span class="badge bg-primary">${entry.quantity}</span></td>
                     <td>${entry.unit}</td>
                     <td>${entry.supplier}</td>
                     <td>${entry.entry_date}</td>
                     <td>
                         <button class="btn btn-success btn-sm" onclick="showPrintQuantityModal(${entry.id}, '${entry.reagent_name}', ${entry.quantity}, '${entry.unit}')">
                             <i class="fas fa-print me-1"></i>列印
                         </button>
                     </td>
                 `;
                 tbody.appendChild(row);
             });
         }





        // 顯示列印數量選擇器
        function showPrintQuantityModal(entryId, reagentName, originalQuantity, unit) {
            // 設定模態框內容
            document.getElementById('printReagentName').textContent = reagentName;
            document.getElementById('printOriginalQuantity').textContent = originalQuantity + ' ' + unit;
            document.getElementById('printQuantity').value = originalQuantity;
            
            // 儲存entryId供確認列印使用
            window.currentPrintEntryId = entryId;
            
            // 顯示模態框
            const modal = new bootstrap.Modal(document.getElementById('printQuantityModal'));
            modal.show();
        }

        // 確認列印
        async function confirmPrint() {
            const quantity = parseInt(document.getElementById('printQuantity').value);
            const printerType = document.getElementById('printPrinterType').value;
            const entryId = window.currentPrintEntryId;
            
            if (quantity > 0) {
                // 關閉模態框
                bootstrap.Modal.getInstance(document.getElementById('printQuantityModal')).hide();
                
                // 執行列印
                await directPrint(entryId, quantity, printerType);
            } else {
                alert('請輸入有效的數量');
            }
        }

                // 直接列印到預設印表機
        async function directPrint(entryId, defaultQuantity, printerType = 'zpl') {
            try {
                const response = await fetch(`/api/print-direct/${entryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        quantity: defaultQuantity,
                        printer_type: printerType
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    alert('列印失敗：' + (result.message || '未知錯誤'));
                }
            } catch (error) {
                console.error('列印失敗:', error);
                alert('列印失敗，請重試');
            }
        }

        // 新增入庫後直接列印標籤（靜默處理，不顯示錯誤給使用者）
        async function directPrintNewEntry(entryId, quantity, isNewBatch = false, printerType = 'zpl') {
            try {
                console.log('開始列印新入庫標籤，ID:', entryId, '數量:', quantity, '新批號:', isNewBatch, '標籤機類型:', printerType);
                
                const response = await fetch(`/api/print-direct/${entryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        quantity: quantity,
                        is_new_batch: isNewBatch,
                        printer_type: printerType
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    console.error('列印失敗：', result.message);
                    // 不顯示錯誤訊息給使用者，避免影響入庫流程
        } else {
                    console.log('標籤列印成功');
                }
            } catch (error) {
                console.error('列印過程發生錯誤:', error);
                // 靜默處理錯誤，不影響入庫成功
            }
        }

        // 顯示成功提示
        function showSuccessModal(message) {
            document.getElementById('successMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        }

         // 表單提交處理
         document.getElementById('entryForm').addEventListener('submit', async function(e) {
             e.preventDefault();

             // 驗證表單
             if (!validateForm()) {
                 return;
             }

             const formData = {
                 reagent_name: document.getElementById('reagentName').value,
                 reagent_batch_number: document.getElementById('reagentBatchNumber').value,
                 expiry_date: document.getElementById('expiryDate').value,
                 quantity: parseInt(document.getElementById('quantity').value),
                 unit: document.getElementById('unit').value === '其他' ? document.getElementById('unitOther').value : document.getElementById('unit').value,
                 supplier: document.getElementById('supplier').value === '其他' ? document.getElementById('supplierOther').value : document.getElementById('supplier').value,
                 printer_type: document.getElementById('printerType').value
             };

             try {
                 const response = await fetch('/api/entries', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify(formData)
                 });

                 const result = await response.json();
                 
                                   if (result.success) {
                      // 一般入庫成功
                   
                   // 入庫成功後，直接列印標籤
                   if (result.entry_id) {
                       await directPrintNewEntry(result.entry_id, formData.quantity, result.is_new_batch || false, formData.printer_type);
                   }
                      
                      // 清空表單
                      document.getElementById('entryForm').reset();
                      
                      // 重新載入記錄
                      loadEntries();
                    
                    // 不顯示成功對話視窗，靜默處理
                  } else if (result.is_new_batch) {
                     // 檢測到新批號，顯示確認模態框
                     showNewBatchModal(result.message, result.data);
            } else {
                     // 其他錯誤
                     alert('操作失敗：' + (result.message || '未知錯誤'));
                 }
             } catch (error) {
                 console.error('儲存失敗:', error);
                 alert('儲存失敗，請重試');
             }
         });

         // 顯示新批號確認模態框
         function showNewBatchModal(message, data) {
             // 設置模態框內容
             document.getElementById('newBatchMessage').textContent = message;
             document.getElementById('previewReagentName').textContent = data.reagent_name;
             document.getElementById('previewBatchNumber').textContent = data.reagent_batch_number;
             document.getElementById('previewExpiryDate').textContent = data.expiry_date;
             document.getElementById('previewQuantity').textContent = data.quantity;
             document.getElementById('previewUnit').textContent = data.unit;
             document.getElementById('previewSupplier').textContent = data.supplier;
             
             // 儲存資料供確認時使用
             window.pendingEntryData = data;
             
             // 顯示模態框
             const modal = new bootstrap.Modal(document.getElementById('newBatchModal'));
             modal.show();
         }

         // 確認新批號入庫
         async function confirmNewBatchEntry() {
             if (!window.pendingEntryData) {
                 alert('沒有待確認的入庫資料');
                 return;
             }

             try {
                 // 添加標籤機類型到待確認資料
                 const dataWithPrinterType = {
                     ...window.pendingEntryData,
                     printer_type: document.getElementById('printerType').value
                 };
                 
                 const response = await fetch('/api/confirm-entry', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify(dataWithPrinterType)
                 });

                 const result = await response.json();
                 
                                   if (result.success) {
                      // 入庫成功
                   
                   // 入庫成功後，直接列印標籤（新批號）
                   if (result.entry_id) {
                       const printerType = document.getElementById('printerType').value;
                       await directPrintNewEntry(result.entry_id, window.pendingEntryData.quantity, result.is_new_batch || true, printerType);
                   }
                      
                      // 清空表單
                      document.getElementById('entryForm').reset();
                      
                      // 重新載入記錄
                      loadEntries();
                      
                      // 關閉新批號確認模態框
                      bootstrap.Modal.getInstance(document.getElementById('newBatchModal')).hide();
                      
                      // 清除待確認資料
                      window.pendingEntryData = null;
                    
                    // 不顯示成功對話視窗，靜默處理
            } else {
                     alert('確認入庫失敗：' + (result.message || '未知錯誤'));
                 }
             } catch (error) {
                 console.error('確認入庫失敗:', error);
                 alert('確認入庫失敗，請重試');
             }
         }



         // 處理單位選擇變更
         function handleUnitChange() {
             const unitSelect = document.getElementById('unit');
             const unitOther = document.getElementById('unitOther');
             
             if (unitSelect.value === '其他') {
                 unitOther.style.display = 'block';
                 unitOther.required = true;
                 unitOther.focus();
             } else {
                 unitOther.style.display = 'none';
                 unitOther.required = false;
                 unitOther.value = '';
             }
         }

         // 處理供應商選擇變更
         function handleSupplierChange() {
             const supplierSelect = document.getElementById('supplier');
             const supplierOther = document.getElementById('supplierOther');
             
             if (supplierSelect.value === '其他') {
                 supplierOther.style.display = 'block';
                 supplierOther.required = true;
                 supplierOther.focus();
             } else {
                 supplierOther.style.display = 'none';
                 supplierOther.required = false;
                 supplierOther.value = '';
             }
         }

         // 表單驗證
         function validateForm() {
             const unitSelect = document.getElementById('unit');
             const unitOther = document.getElementById('unitOther');
             const supplierSelect = document.getElementById('supplier');
             const supplierOther = document.getElementById('supplierOther');

             // 驗證單位
             if (unitSelect.value === '其他' && !unitOther.value.trim()) {
                 alert('請輸入其他單位');
                 unitOther.focus();
                 return false;
             }

             // 驗證供應商
             if (supplierSelect.value === '其他' && !supplierOther.value.trim()) {
                 alert('請輸入其他供應商');
                 supplierOther.focus();
                 return false;
             }

             return true;
         }

         // 套用篩選器
         function applyFilters() {
             const filterName = document.getElementById('filterName').value.trim();
            const filterBatch = document.getElementById('filterBatch').value.trim();
             const filterSupplier = document.getElementById('filterSupplier').value;
             const filterDateFrom = document.getElementById('filterDateFrom').value;
             const filterDateTo = document.getElementById('filterDateTo').value;

             let filteredEntries = allEntries.filter(entry => {
                 // 名稱篩選
                 if (filterName && !entry.reagent_name.toLowerCase().includes(filterName.toLowerCase())) {
                     return false;
                 }

                // 批號篩選
                if (filterBatch && !entry.reagent_batch_number.toLowerCase().includes(filterBatch.toLowerCase())) {
                    return false;
                }

                 // 供應商篩選
                 if (filterSupplier && entry.supplier !== filterSupplier) {
                     return false;
                 }

                 // 日期範圍篩選
                 if (filterDateFrom || filterDateTo) {
                     const entryDate = new Date(entry.entry_date.split(' ')[0]); // 只取日期部分
                     
                     if (filterDateFrom && entryDate < new Date(filterDateFrom)) {
                         return false;
                     }
                     
                     if (filterDateTo && entryDate > new Date(filterDateTo)) {
                         return false;
                     }
                 }

                 return true;
             });

             displayEntries(filteredEntries);
         }

         // 清除篩選器
         function clearFilters() {
             document.getElementById('filterName').value = '';
            document.getElementById('filterBatch').value = '';
             document.getElementById('filterSupplier').value = '';
             document.getElementById('filterDateFrom').value = '';
             document.getElementById('filterDateTo').value = '';
             
             // 重新顯示所有記錄
             displayEntries(allEntries);
         }

         // 匯出CSV功能
         function exportToCSV() {
             const currentEntries = allEntries;
             if (currentEntries.length === 0) {
                 alert('沒有資料可以匯出');
        return;
    }
    
             // CSV標題
             const headers = ['試劑名稱', '試劑批號', '穩定效期', '數量', '單位', '供應商', '入庫日期'];
             
             // CSV內容
             const csvContent = [
                 headers.join(','),
                 ...currentEntries.map(entry => [
                     entry.reagent_name,
                     entry.reagent_batch_number,
                     entry.expiry_date,
                     entry.quantity,
                     entry.unit,
                     entry.supplier,
                     entry.entry_date
                 ].join(','))
             ].join('\n');

             // 創建下載連結
             const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement('a');
             const url = URL.createObjectURL(blob);
             link.setAttribute('href', url);
             link.setAttribute('download', `試劑入庫紀錄_${new Date().toISOString().split('T')[0]}.csv`);
             link.style.visibility = 'hidden';
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
         }

         // 顯示匯入模態框
         function showImportModal() {
             // 重置表單
             document.getElementById('csvFile').value = '';
             document.getElementById('importBtn').disabled = true;
             document.getElementById('importProgress').classList.add('d-none');
             document.getElementById('importResult').classList.add('d-none');
             
             // 顯示模態框
             const importModal = new bootstrap.Modal(document.getElementById('importModal'));
             importModal.show();
         }

         // 驗證檔案
         function validateFile() {
             const fileInput = document.getElementById('csvFile');
             const importBtn = document.getElementById('importBtn');
             
             if (fileInput.files.length > 0) {
                 const file = fileInput.files[0];
                 
                 // 檢查檔案類型
                 if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                     importBtn.disabled = false;
                 } else {
                     alert('請選擇CSV檔案');
                     fileInput.value = '';
                     importBtn.disabled = true;
                 }
             } else {
                 importBtn.disabled = true;
             }
         }

         // 下載CSV範本
         function downloadTemplate() {
             const headers = ['試劑名稱', '試劑批號', '穩定效期', '數量', '單位', '供應商', '入庫日期'];
             const sampleData = [
                 ['GOT', 'GOT001', '2025-12-31', '10', '組', '亞培', '2025-08-22 09:00:00'],
                 ['GPT', 'GPT001', '2025-12-31', '5', '組', '羅氏', '2025-08-22 10:00:00']
             ];
             
             const csvContent = [
                 headers.join(','),
                 ...sampleData.map(row => row.join(','))
             ].join('\n');
             
             const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement('a');
             const url = URL.createObjectURL(blob);
             link.setAttribute('href', url);
             link.setAttribute('download', '試劑入庫紀錄_CSV範本.csv');
             link.style.visibility = 'hidden';
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
         }

         // 匯入CSV檔案
         async function importCSV() {
             const fileInput = document.getElementById('csvFile');
             const importBtn = document.getElementById('importBtn');
             const importProgress = document.getElementById('importProgress');
             const importResult = document.getElementById('importResult');
             
             if (fileInput.files.length === 0) {
                 alert('請選擇要匯入的CSV檔案');
                 return;
             }
             
             const file = fileInput.files[0];
             
             // 顯示進度條
             importProgress.classList.remove('d-none');
             importBtn.disabled = true;
             
             try {
                 // 建立FormData
                 const formData = new FormData();
                 formData.append('file', file);
                 
                 // 發送請求
                 const response = await fetch('/api/import-csv', {
                     method: 'POST',
                     body: formData
                 });
                 
                 const result = await response.json();
                 
                 // 隱藏進度條
                 importProgress.classList.add('d-none');
                 
                 if (result.success) {
                     // 顯示成功結果
                     importResult.classList.remove('d-none');
                     importResult.innerHTML = `
                         <div class="alert alert-success">
                             <h6 class="alert-heading">匯入成功！</h6>
                             <p class="mb-0">${result.message}</p>
                             <hr>
                             <p class="mb-0"><strong>成功處理：</strong>${result.success_count} 筆記錄</p>
                             <p class="mb-0"><strong>失敗記錄：</strong>${result.error_count} 筆</p>
                        </div>
                     `;
                     
                     // 如果有錯誤，顯示錯誤詳情
                     if (result.errors && result.errors.length > 0) {
                         importResult.innerHTML += `
                             <div class="alert alert-warning">
                                 <h6 class="alert-heading">錯誤詳情：</h6>
                                 <ul class="mb-0">
                                     ${result.errors.map(error => `<li>${error}</li>`).join('')}
                                 </ul>
                    </div>
                         `;
                     }
                     
                     // 重新載入資料
                     await loadEntries();
                     
                     // 3秒後自動隱藏結果
                     setTimeout(() => {
                         importResult.classList.add('d-none');
                     }, 3000);
                     
                 } else {
                     // 顯示錯誤訊息
                     importResult.classList.remove('d-none');
                     importResult.innerHTML = `
                         <div class="alert alert-danger">
                             <h6 class="alert-heading">匯入失敗</h6>
                             <p class="mb-0">${result.error}</p>
                         </div>
                     `;
                 }
                 
                 // 重新啟用匯入按鈕
                 importBtn.disabled = false;
                 
             } catch (error) {
                 console.error('匯入失敗:', error);
                 
                 // 隱藏進度條
                 importProgress.classList.add('d-none');
                 
                 // 顯示錯誤訊息
                 importResult.classList.remove('d-none');
                 importResult.innerHTML = `
                     <div class="alert alert-danger">
                         <h6 class="alert-heading">匯入失敗</h6>
                         <p class="mb-0">網路錯誤或伺服器問題，請稍後再試</p>
                     </div>
                 `;
                 
                 // 重新啟用匯入按鈕
                 importBtn.disabled = false;
             }
}
</script>
</body>
</html>
