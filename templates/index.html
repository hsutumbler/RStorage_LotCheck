<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©¦åŠ‘å…¥åº«ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 20px;
            padding: 30px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            border: none;
            border-radius: 25px;
            padding: 8px 20px;
        }
        .btn-warning {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            border: none;
            border-radius: 25px;
            padding: 8px 20px;
        }
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .table {
            border-radius: 15px;
            overflow: hidden;
        }
        .table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-weight: 600;
        }
        .alert {
            border-radius: 15px;
            border: none;
        }
        .modal-content {
            border-radius: 20px;
            border: none;
        }
        .search-box {
            position: relative;
        }
        .search-box .form-control {
            padding-right: 50px;
        }
        .search-box .btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }
        .batch-new {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .batch-old {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .nav-tabs {
            border: none;
            margin-bottom: 30px;
        }
        .nav-tabs .nav-link {
            border: none;
            border-radius: 15px 15px 0 0;
            margin-right: 10px;
            padding: 15px 30px;
            font-weight: 600;
            color: #6c757d;
            background: rgba(108, 117, 125, 0.1);
            transition: all 0.3s ease;
        }
        .nav-tabs .nav-link:hover {
            background: rgba(108, 117, 125, 0.2);
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .tab-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* è‡ªå‹•å®Œæˆæ¨£å¼ */
        .suggestion-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa !important;
        }
        
        .suggestion-item.bg-primary:hover {
            background-color: #0056b3 !important;
        }
        
        #reagentSuggestions {
            border-top: none !important;
            border-radius: 0 0 0.375rem 0.375rem !important;
            border-color: #dee2e6;
        }
        
        #reagentName:focus + #reagentSuggestions {
            border-color: #86b7fe;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }

        /* æ™ºèƒ½è¡¨å–®å¡«å……æ¨£å¼ */
        .auto-filled {
            background-color: #e8f5e8 !important;
            border-color: #28a745 !important;
        }

        .auto-suggested {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
        }

        input[readonly].auto-filled {
            background-color: #e8f5e8 !important;
            cursor: not-allowed;
        }

        .auto-fill-notification {
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }

        /* æ‰¹è™Ÿå»ºè­°æ¡†æ¨£å¼ */
        #batchSuggestions {
            border-top: none !important;
            border-radius: 0 0 0.375rem 0.375rem !important;
            border-color: #dee2e6;
        }

        #reagentBatchNumber:focus + #batchSuggestions {
            border-color: #86b7fe;
        }

        #batchSuggestions .suggestion-item {
            border-color: #dee2e6;
        }

        #batchSuggestions .suggestion-item:hover {
            background-color: #f8f9fa !important;
        }

        #batchSuggestions .suggestion-item.bg-primary:hover {
            background-color: #0056b3 !important;
        }

    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
        <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary mb-3">
                    <i class="fas fa-flask me-3"></i>è©¦åŠ‘å…¥åº«ç®¡ç†ç³»çµ±
            </h1>
                <p class="lead text-muted">å°ˆæ¥­çš„è©¦åŠ‘åº«å­˜ç®¡ç†è§£æ±ºæ–¹æ¡ˆ</p>
        </div>

            <!-- é ç±¤å°èˆª -->
            <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="entry-tab" data-bs-toggle="tab" data-bs-target="#entry" type="button" role="tab">
                        <i class="fas fa-plus-circle me-2"></i>æ–°å¢å…¥åº«
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="search-records-tab" data-bs-toggle="tab" data-bs-target="#search-records" type="button" role="tab">
                        <i class="fas fa-search me-2"></i>æœå°‹èˆ‡ç´€éŒ„
                    </button>
                </li>
            </ul>

            <!-- é ç±¤å…§å®¹ -->
            <div class="tab-content" id="mainTabsContent">
                <!-- æ–°å¢å…¥åº«é ç±¤ -->
                <div class="tab-pane fade show active" id="entry" role="tabpanel">
        <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>æ–°å¢å…¥åº«è³‡æ–™</h5>
            </div>
                        <div class="card-body">
                                                         <form id="entryForm">
                                 <div class="row">
                                     <div class="col-md-6 mb-3">
                                         <label for="reagentName" class="form-label fw-bold">è©¦åŠ‘åç¨± *</label>
                                         <div class="position-relative">
                                             <input type="text" class="form-control" id="reagentName" required 
                                                    autocomplete="off" placeholder="è¼¸å…¥è©¦åŠ‘åç¨±...">
                                             <div id="reagentSuggestions" class="position-absolute w-100 bg-white border border-top-0 rounded-bottom shadow-sm" 
                                                  style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                                     <div class="col-md-6 mb-3">
                                         <label for="reagentBatchNumber" class="form-label fw-bold">è©¦åŠ‘æ‰¹è™Ÿ *</label>
                                        <div class="position-relative">
                                            <input type="text" class="form-control" id="reagentBatchNumber" required
                                                   autocomplete="off" placeholder="è¼¸å…¥è©¦åŠ‘æ‰¹è™Ÿ...">
                                            <div id="batchSuggestions" class="position-absolute w-100 bg-white border border-top-0 rounded-bottom shadow-sm" 
                                                 style="display: none; z-index: 999; max-height: 150px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                    </div>
                                 <div class="row">
                                     <div class="col-md-6 mb-3">
                                         <label for="expiryDate" class="form-label fw-bold">ç©©å®šæ•ˆæœŸ *</label>
                                         <input type="date" class="form-control" id="expiryDate" required>
                                </div>
                                     <div class="col-md-6 mb-3">
                                         <label for="quantity" class="form-label fw-bold">å…¥åº«æ•¸é‡ *</label>
                                         <input type="number" class="form-control" id="quantity" min="1" required>
                            </div>
                        </div>
                                 <div class="row">
                                     <div class="col-md-6 mb-3">
                                         <label for="unit" class="form-label fw-bold">å–®ä½ *</label>
                                         <select class="form-control" id="unit" required onchange="handleUnitChange()">
                                             <option value="">è«‹é¸æ“‡å–®ä½</option>
                                             <option value="ç®±">ç®±</option>
                                             <option value="ç›’">ç›’</option>
                                             <option value="ç“¶">ç“¶</option>
                                             <option value="çµ„">çµ„</option>
                                             <option value="å…¶ä»–">å…¶ä»–</option>
                                         </select>
                                         <input type="text" class="form-control mt-2" id="unitOther" placeholder="è«‹è¼¸å…¥å…¶ä»–å–®ä½" style="display: none;">
                                </div>
                                     <div class="col-md-6 mb-3">
                                         <label for="supplier" class="form-label fw-bold">ä¾›æ‡‰å•† *</label>
                                         <select class="form-control" id="supplier" required onchange="handleSupplierChange()">
                                             <option value="">è«‹é¸æ“‡ä¾›æ‡‰å•†</option>
                                             <option value="é†«å…¨">é†«å…¨</option>
                                             <option value="äºåŸ¹">äºåŸ¹</option>
                                             <option value="å¸Œæ£®ç¾åº·">å¸Œæ£®ç¾åº·</option>
                                             <option value="æ²ƒèŠ¬">æ²ƒèŠ¬</option>
                                             <option value="å…¶ä»–">å…¶ä»–</option>
                                         </select>
                                         <input type="text" class="form-control mt-2" id="supplierOther" placeholder="è«‹è¼¸å…¥å…¶ä»–ä¾›æ‡‰å•†" style="display: none;">
                            </div>
                                                                 </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="printerType" class="form-label fw-bold">æ¨™ç±¤æ©Ÿé¡å‹ *</label>
                                        <select class="form-control" id="printerType" required>
                                            <option value="zpl">ã€å¤§æ¨™ç±¤æ©Ÿ(ZPLæ¨¡å¼)ã€‘</option>
                                            <option value="pdf">ã€å°æ¨™ç±¤æ©Ÿ(PDFæ¨¡å¼)ã€‘</option>
                                        </select>
                                        <div class="form-text">è«‹é¸æ“‡å°æ‡‰çš„æ¨™ç±¤æ©Ÿé¡å‹</div>
                        </div>
                    </div>
                    
                               <div class="text-center">
                                   <button type="submit" class="btn btn-primary btn-lg">
                                      <i class="fas fa-save me-2"></i>å„²å­˜ä¸¦è‡ªå‹•åˆ—å°æ¨™ç±¤
                                   </button>
                               </div>
                            </form>
                        </div>
                        </div>
                    </div>
                    
                <!-- æœå°‹èˆ‡ç´€éŒ„æ•´åˆé ç±¤ -->
                <div class="tab-pane fade" id="search-records" role="tabpanel">
                    <!-- ç¯©é¸å™¨å€åŸŸ -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>ç¯©é¸æœå°‹</h5>
                            <button class="btn btn-outline-light btn-sm" onclick="switchToSearchTab()" title="é‡æ–°è¼‰å…¥è³‡æ–™">
                                <i class="fas fa-sync-alt"></i>
                        </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label for="filterName" class="form-label fw-bold">è©¦åŠ‘åç¨±</label>
                                    <input type="text" class="form-control" id="filterName" placeholder="è¼¸å…¥è©¦åŠ‘åç¨±">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="filterBatch" class="form-label fw-bold">æ‰¹è™Ÿ</label>
                                    <input type="text" class="form-control" id="filterBatch" placeholder="è¼¸å…¥æ‰¹è™Ÿ">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="filterSupplier" class="form-label fw-bold">ä¾›æ‡‰å•†</label>
                                    <select class="form-control" id="filterSupplier">
                                        <option value="">å…¨éƒ¨ä¾›æ‡‰å•†</option>
                                        <option value="é†«å…¨">é†«å…¨</option>
                                        <option value="äºåŸ¹">äºåŸ¹</option>
                                        <option value="å¸Œæ£®ç¾åº·">å¸Œæ£®ç¾åº·</option>
                                        <option value="æ²ƒèŠ¬">æ²ƒèŠ¬</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="filterDateFrom" class="form-label fw-bold">é–‹å§‹æ—¥æœŸ</label>
                                    <input type="date" class="form-control" id="filterDateFrom">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="filterDateTo" class="form-label fw-bold">çµæŸæ—¥æœŸ</label>
                                    <input type="date" class="form-control" id="filterDateTo">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3 d-flex justify-content-center">
                                    <button class="btn btn-primary me-3" onclick="applyFilters()">
                                        <i class="fas fa-filter me-2"></i>å¥—ç”¨ç¯©é¸
                        </button>
                                    <button class="btn btn-primary" onclick="clearFilters()">
                                        <i class="fas fa-times me-2"></i>æ¸…é™¤ç¯©é¸
                        </button>
                    </div>
                            </div>
            </div>
        </div>
        
                    <!-- è³‡æ–™é¡¯ç¤ºå€åŸŸ -->
                    <div class="card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>å…¥åº«ç´€éŒ„</h5>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-light text-dark me-3" id="recordCount">å…± 0 ç­†è¨˜éŒ„</span>
                                <button class="btn btn-outline-light btn-sm me-2" onclick="exportToCSV()">
                                    <i class="fas fa-download me-1"></i>åŒ¯å‡º
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="showImportModal()">
                                    <i class="fas fa-upload me-1"></i>åŒ¯å…¥
                                </button>
            </div>
                        </div>
                        <div class="card-body">
                <div class="table-responsive">
                                <table class="table table-hover">
                        <thead>
                            <tr>
                                            <th>è©¦åŠ‘åç¨±</th>
                                            <th>è©¦åŠ‘æ‰¹è™Ÿ</th>
                                            <th>ç©©å®šæ•ˆæœŸ</th>
                                            <th>æ•¸é‡</th>
                                            <th>å–®ä½</th>
                                            <th>ä¾›æ‡‰å•†</th>
                                            <th>å…¥åº«æ—¥æœŸ</th>
                                            <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                                    <tbody id="entriesTableBody">
                                        <!-- è³‡æ–™å°‡ç”±JavaScriptå‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>



    <!-- æˆåŠŸæç¤ºæ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">æ“ä½œæˆåŠŸ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="successMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°æ‰¹è™Ÿç¢ºèªæ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="newBatchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>æ–°æ‰¹è™Ÿç¢ºèª
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">æª¢æ¸¬åˆ°æ–°æ‰¹è™Ÿï¼</h6>
                        <p id="newBatchMessage" class="mb-0"></p>
                    </div>
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">å…¥åº«è³‡æ–™é è¦½</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>è©¦åŠ‘åç¨±:</strong> <span id="previewReagentName"></span></p>
                                    <p><strong>è©¦åŠ‘æ‰¹è™Ÿ:</strong> <span id="previewBatchNumber"></span></p>
                                    <p><strong>ç©©å®šæ•ˆæœŸ:</strong> <span id="previewExpiryDate"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>å…¥åº«æ•¸é‡:</strong> <span id="previewQuantity"></span></p>
                                    <p><strong>å–®ä½:</strong> <span id="previewUnit"></span></p>
                                    <p><strong>ä¾›æ‡‰å•†:</strong> <span id="previewSupplier"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-warning" onclick="confirmNewBatchEntry()">
                        <i class="fas fa-check me-2"></i>ç¢ºèªå…¥åº«
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ—å°æ•¸é‡é¸æ“‡å™¨æ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="printQuantityModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">ğŸ“‹ åˆ—å°æ•¸é‡è¨­å®š</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <span class="fw-bold">è©¦åŠ‘åç¨±ï¼š</span>
                        <span id="printReagentName" class="text-primary"></span>
                    </div>
                    <div class="mb-3">
                        <span class="fw-bold">å…¥åº«æ•¸é‡ï¼š</span>
                        <span id="printOriginalQuantity" class="text-primary"></span>
                    </div>
                    <div class="mb-3">
                        <label for="printQuantity" class="form-label fw-bold">åˆ—å°æ•¸é‡ï¼š</label>
                        <div class="input-group">
                            <span class="fw-bold text-primary fs-5">ã€</span>
                            <input type="number" class="form-control text-center" id="printQuantity" min="1" max="999" style="border: none; box-shadow: none;">
                            <span class="fw-bold text-primary fs-5">ã€‘çµ„</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="printPrinterType" class="form-label fw-bold">æ¨™ç±¤æ©Ÿé¡å‹ï¼š</label>
                        <select class="form-control" id="printPrinterType" required>
                            <option value="zpl">ã€å¤§æ¨™ç±¤æ©Ÿ(ZPLæ¨¡å¼)ã€‘</option>
                            <option value="pdf">ã€å°æ¨™ç±¤æ©Ÿ(PDFæ¨¡å¼)ã€‘</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmPrint()">ç¢ºèªåˆ—å°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŒ¯å…¥CSVæ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-upload me-2"></i>åŒ¯å…¥CSVæª”æ¡ˆ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6 class="alert-heading">åŒ¯å…¥èªªæ˜</h6>
                        <ul class="mb-0">
                            <li>è«‹é¸æ“‡CSVæª”æ¡ˆï¼Œæª”æ¡ˆå¿…é ˆåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼šè©¦åŠ‘åç¨±ã€è©¦åŠ‘æ‰¹è™Ÿã€ç©©å®šæ•ˆæœŸã€æ•¸é‡ã€å–®ä½ã€ä¾›æ‡‰å•†ã€å…¥åº«æ—¥æœŸ</li>
                            <li>æ—¥æœŸæ ¼å¼æ”¯æ´ï¼šYYYY-MM-DD æˆ– YYYY/MM/DD</li>
                            <li>å…¥åº«æ—¥æœŸæ ¼å¼æ”¯æ´ï¼šYYYY-MM-DD HH:MM:SS æˆ– YYYY/MM/DD</li>
                            <li>å¦‚æœè©¦åŠ‘åç¨±å’Œæ‰¹è™Ÿå·²å­˜åœ¨ï¼Œç³»çµ±æœƒæ›´æ–°è©²ç­†è¨˜éŒ„</li>
                            <li>æ”¯æ´UTF-8ç·¨ç¢¼çš„CSVæª”æ¡ˆ</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">é¸æ“‡CSVæª”æ¡ˆ</label>
                        <input type="file" class="form-control" id="csvFile" accept=".csv" onchange="validateFile()">
                        <div class="form-text">æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼šCSV</div>
                    </div>

                    <div class="mb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="downloadTemplate()">
                            <i class="fas fa-download me-1"></i>ä¸‹è¼‰CSVç¯„æœ¬
                        </button>
                    </div>

                    <div id="importProgress" class="d-none">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                        <p class="text-center">æ­£åœ¨è™•ç†æª”æ¡ˆï¼Œè«‹ç¨å€™...</p>
                    </div>

                    <div id="importResult" class="d-none">
                        <!-- åŒ¯å…¥çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="importBtn" onclick="importCSV()" disabled>
                        <i class="fas fa-upload me-2"></i>é–‹å§‹åŒ¯å…¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
        let allEntries = [];

        // é é¢è¼‰å…¥æ™‚ç²å–æ‰€æœ‰è¨˜éŒ„
document.addEventListener('DOMContentLoaded', function() {
            loadEntries();
            initializeAutocomplete();
        });

        // è‡ªå‹•å®ŒæˆåŠŸèƒ½è®Šæ•¸
        let currentSuggestions = [];
        let selectedSuggestionIndex = -1;
        let suggestionTimeout;
        
        // æ‰¹è™Ÿè‡ªå‹•å®Œæˆè®Šæ•¸
        let currentBatchSuggestions = [];
        let selectedBatchSuggestionIndex = -1;
        let batchSuggestionTimeout;

        // åˆå§‹åŒ–è‡ªå‹•å®ŒæˆåŠŸèƒ½
        function initializeAutocomplete() {
            const reagentInput = document.getElementById('reagentName');
            const suggestionsDiv = document.getElementById('reagentSuggestions');
            
            if (!reagentInput || !suggestionsDiv) {
                console.error('æ‰¾ä¸åˆ°è©¦åŠ‘åç¨±è¼¸å…¥æ¬„ä½æˆ–å»ºè­°å€åŸŸ');
                return;
            }
            
            // è¼¸å…¥äº‹ä»¶
            reagentInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                // æ¸…é™¤ä¹‹å‰çš„å»¶é²
                clearTimeout(suggestionTimeout);
                
                if (query.length === 0) {
                    hideSuggestions();
                    return;
                }
                
                // å»¶é²æœå°‹ï¼Œé¿å…éæ–¼é »ç¹çš„è«‹æ±‚
                suggestionTimeout = setTimeout(() => {
                    fetchSuggestions(query);
                }, 300);
            });
            
            // éµç›¤å°èˆª
            reagentInput.addEventListener('keydown', function(e) {
                const suggestionsDiv = document.getElementById('reagentSuggestions');
                const isVisible = suggestionsDiv.style.display !== 'none';
                
                if (!isVisible) return;
                
                switch(e.key) {
                    case 'ArrowDown':
        e.preventDefault();
                        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, currentSuggestions.length - 1);
                        updateSuggestionSelection();
                        break;
                        
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                        updateSuggestionSelection();
                        break;
                        
                    case 'Enter':
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0) {
                            selectSuggestion(currentSuggestions[selectedSuggestionIndex]);
                        }
                        break;
                        
                    case 'Escape':
                        e.preventDefault();
                        hideSuggestions();
                        break;
                }
            });
            
            // å¤±å»ç„¦é»æ™‚éš±è—å»ºè­°
            reagentInput.addEventListener('blur', function() {
                // å»¶é²éš±è—ï¼Œè®“é»æ“Šäº‹ä»¶æœ‰æ™‚é–“è§¸ç™¼
                setTimeout(hideSuggestions, 200);
            });
            
            // æ–°å¢ï¼šè©¦åŠ‘åç¨±è®Šæ›´æ™‚è‡ªå‹•å¡«å……ä¾›æ‡‰å•†
            reagentInput.addEventListener('change', function(e) {
                const reagentName = e.target.value.trim();
                if (reagentName) {
                    loadReagentSupplier(reagentName);
                }
            });
            
            // æ–°å¢ï¼šåˆå§‹åŒ–æ‰¹è™Ÿè‡ªå‹•å®Œæˆ
            initializeBatchAutocomplete();
        }

        // åˆå§‹åŒ–æ‰¹è™Ÿè‡ªå‹•å®ŒæˆåŠŸèƒ½
        function initializeBatchAutocomplete() {
            const batchInput = document.getElementById('reagentBatchNumber');
            const batchSuggestionsDiv = document.getElementById('batchSuggestions');
            
            if (!batchInput || !batchSuggestionsDiv) {
                console.error('æ‰¾ä¸åˆ°æ‰¹è™Ÿè¼¸å…¥æ¬„ä½æˆ–å»ºè­°å€åŸŸ');
                return;
            }
            
            // æ‰¹è™Ÿè¼¸å…¥äº‹ä»¶
            batchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                const reagentName = document.getElementById('reagentName').value.trim();
                
                clearTimeout(batchSuggestionTimeout);
                
                if (query.length === 0 || !reagentName) {
                    hideBatchSuggestions();
                    clearExpiryDate();
                    return;
                }
                
                batchSuggestionTimeout = setTimeout(() => {
                    fetchBatchSuggestions(reagentName, query);
                }, 300);
            });
            
            // æ‰¹è™Ÿéµç›¤äº‹ä»¶
            batchInput.addEventListener('keydown', function(e) {
                if (currentBatchSuggestions.length === 0) return;
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedBatchSuggestionIndex = Math.min(selectedBatchSuggestionIndex + 1, currentBatchSuggestions.length - 1);
                        updateBatchSuggestionSelection();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedBatchSuggestionIndex = Math.max(selectedBatchSuggestionIndex - 1, -1);
                        updateBatchSuggestionSelection();
                        break;
                    case 'Enter':
                        if (selectedBatchSuggestionIndex >= 0) {
                            e.preventDefault();
                            selectBatchSuggestion(currentBatchSuggestions[selectedBatchSuggestionIndex].batch_number);
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        hideBatchSuggestions();
                        break;
                }
            });
            
            // æ‰¹è™Ÿè®Šæ›´æ™‚è¼‰å…¥æ•ˆæœŸ
            batchInput.addEventListener('change', function(e) {
                const batchNumber = e.target.value.trim();
                const reagentName = document.getElementById('reagentName').value.trim();
                
                if (batchNumber && reagentName) {
                    loadBatchExpiry(reagentName, batchNumber);
                }
            });
            
            // å¤±å»ç„¦é»æ™‚éš±è—æ‰¹è™Ÿå»ºè­°
            batchInput.addEventListener('blur', function() {
                setTimeout(hideBatchSuggestions, 200);
            });
        }

        // ç²å–å»ºè­°
        async function fetchSuggestions(query) {
            try {
                const response = await fetch(`/api/reagent-suggestions?q=${encodeURIComponent(query)}`);
                const suggestions = await response.json();
                
                currentSuggestions = suggestions;
                selectedSuggestionIndex = -1;
                
                displaySuggestions(suggestions);
            } catch (error) {
                console.error('ç²å–å»ºè­°å¤±æ•—:', error);
                hideSuggestions();
            }
        }

        // é¡¯ç¤ºå»ºè­°
        function displaySuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('reagentSuggestions');
            
            if (suggestions.length === 0) {
                hideSuggestions();
        return;
    }
    
            const html = suggestions.map((suggestion, index) => `
                <div class="suggestion-item p-2 border-bottom cursor-pointer" 
                     data-index="${index}" 
                     onclick="selectSuggestion('${suggestion.replace(/'/g, "\\'")}')"
                     onmouseenter="highlightSuggestion(${index})">
                    <i class="fas fa-database text-success me-2"></i>${suggestion}
                </div>
            `).join('');
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
        }

        // æ›´æ–°é¸æ“‡çš„å»ºè­°é«˜äº®
        function updateSuggestionSelection() {
            const items = document.querySelectorAll('.suggestion-item');
            
            items.forEach((item, index) => {
                if (index === selectedSuggestionIndex) {
                    item.classList.add('bg-primary', 'text-white');
                } else {
                    item.classList.remove('bg-primary', 'text-white');
                }
            });
        }

        // é¼ æ¨™æƒ¸åœé«˜äº®
        function highlightSuggestion(index) {
            selectedSuggestionIndex = index;
            updateSuggestionSelection();
        }

        // é¸æ“‡å»ºè­°
        function selectSuggestion(suggestion) {
            document.getElementById('reagentName').value = suggestion;
            hideSuggestions();
            
            // è§¸ç™¼ change äº‹ä»¶
            document.getElementById('reagentName').dispatchEvent(new Event('change'));
        }

        // éš±è—å»ºè­°
        function hideSuggestions() {
            const suggestionsDiv = document.getElementById('reagentSuggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
            currentSuggestions = [];
            selectedSuggestionIndex = -1;
        }

        // ========== æ™ºèƒ½è¡¨å–®å¡«å……åŠŸèƒ½ ==========

        // è¼‰å…¥è©¦åŠ‘å°æ‡‰çš„ä¾›æ‡‰å•†å’Œå–®ä½
        async function loadReagentSupplier(reagentName) {
            try {
                const response = await fetch(`/api/reagent-supplier?name=${encodeURIComponent(reagentName)}`);
                const data = await response.json();
                
                if (data.found) {
                    let autoFillMessages = [];
                    
                    // è‡ªå‹•å¡«å…¥ä¾›æ‡‰å•†
                    if (data.supplier) {
                        const supplierField = document.getElementById('supplier');
                        
                        // åªåœ¨æ¬„ä½ç‚ºç©ºæ™‚è‡ªå‹•å¡«å…¥
                        if (!supplierField.value) {
                            supplierField.value = data.supplier;
                            supplierField.classList.add('auto-filled');
                            
                            // å¦‚æœæ˜¯"å…¶ä»–"é¸é …ï¼Œéœ€è¦è§¸ç™¼è®Šæ›´
                            if (data.supplier === 'å…¶ä»–') {
                                handleSupplierChange();
                            }
                            
                            autoFillMessages.push(`ä¾›æ‡‰å•†: ${data.supplier} (ä½¿ç”¨ ${data.supplier_usage_count} æ¬¡)`);
                        }
                    }
                    
                    // è‡ªå‹•å¡«å…¥å–®ä½
                    if (data.unit) {
                        const unitField = document.getElementById('unit');
                        
                        // åªåœ¨æ¬„ä½ç‚ºç©ºæ™‚è‡ªå‹•å¡«å…¥
                        if (!unitField.value) {
                            unitField.value = data.unit;
                            unitField.classList.add('auto-filled');
                            
                            // å¦‚æœæ˜¯"å…¶ä»–"é¸é …ï¼Œéœ€è¦è§¸ç™¼è®Šæ›´
                            if (data.unit === 'å…¶ä»–') {
                                handleUnitChange();
                            }
                            
                            autoFillMessages.push(`å–®ä½: ${data.unit} (ä½¿ç”¨ ${data.unit_usage_count} æ¬¡)`);
                        }
                    }
                    
                    // é¡¯ç¤ºç¶œåˆé€šçŸ¥
                    if (autoFillMessages.length > 0) {
                        showAutoFillNotification(`âœ¨ å·²è‡ªå‹•å¡«å…¥ ${autoFillMessages.join('ã€')}`);
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥è©¦åŠ‘ä¾›æ‡‰å•†å’Œå–®ä½å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥æ‰¹è™Ÿå°æ‡‰çš„æ•ˆæœŸ
        async function loadBatchExpiry(reagentName, batchNumber) {
            try {
                const response = await fetch(`/api/batch-expiry?name=${encodeURIComponent(reagentName)}&batch=${encodeURIComponent(batchNumber)}`);
                const data = await response.json();
                
                const expiryField = document.getElementById('expiryDate');
                
                if (data.found && !data.is_new_batch) {
                    // å·²çŸ¥æ‰¹è™Ÿ - è‡ªå‹•å¡«å…¥æ•ˆæœŸ
                    expiryField.value = data.expiry_date;
                    expiryField.classList.add('auto-filled');
                    expiryField.readOnly = true; // é–å®šæ¬„ä½ï¼Œå› ç‚ºé€™æ˜¯æ­·å²è³‡æ–™
                    
                    showAutoFillNotification(`ğŸ¯ å·²è¼‰å…¥æ‰¹è™Ÿ "${batchNumber}" çš„æ•ˆæœŸ (ä¸Šæ¬¡å…¥åº«: ${data.last_entry_date})`);
                    
                    // å¯é¸ï¼šå¡«å…¥ä¸Šæ¬¡çš„æ•¸é‡å’Œå–®ä½ä½œç‚ºåƒè€ƒ
                    const quantityField = document.getElementById('quantity');
                    const unitField = document.getElementById('unit');
                    
                    if (!quantityField.value) {
                        quantityField.value = data.previous_quantity;
                        quantityField.classList.add('auto-suggested');
                    }
                    
                    if (!unitField.value) {
                        unitField.value = data.previous_unit;
                        unitField.classList.add('auto-suggested');
                        handleUnitChange(); // è§¸ç™¼å–®ä½è®Šæ›´è™•ç†
                    }
                    
                } else {
                    // æ–°æ‰¹è™Ÿ - æ¸…ç©ºæ•ˆæœŸè®“ä½¿ç”¨è€…è¼¸å…¥
                    expiryField.value = '';
                    expiryField.classList.remove('auto-filled');
                    expiryField.readOnly = false;
                    
                    if (data.is_new_batch) {
                        showNewBatchNotification(`ğŸ†• æ–°æ‰¹è™Ÿ "${batchNumber}" - è«‹æ‰‹å‹•è¼¸å…¥ç©©å®šæ•ˆæœŸ`);
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥æ‰¹è™Ÿæ•ˆæœŸå¤±æ•—:', error);
                clearExpiryDate();
            }
        }

        // ç²å–æ‰¹è™Ÿå»ºè­°
        async function fetchBatchSuggestions(reagentName, query) {
            try {
                const response = await fetch(`/api/reagent-batches?name=${encodeURIComponent(reagentName)}`);
                const batches = await response.json();
                
                const filteredBatches = batches.filter(batch => 
                    batch.batch_number.toUpperCase().includes(query.toUpperCase())
                );
                
                currentBatchSuggestions = filteredBatches;
                selectedBatchSuggestionIndex = -1;
                displayBatchSuggestions(filteredBatches);
            } catch (error) {
                console.error('ç²å–æ‰¹è™Ÿå»ºè­°å¤±æ•—:', error);
                hideBatchSuggestions();
            }
        }

        // é¡¯ç¤ºæ‰¹è™Ÿå»ºè­°ï¼ˆå«æ•ˆæœŸè³‡è¨Šï¼‰
        function displayBatchSuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('batchSuggestions');
            
            if (suggestions.length === 0) {
                hideBatchSuggestions();
        return;
    }
    
            const html = suggestions.map((batch, index) => `
                <div class="suggestion-item p-2 border-bottom cursor-pointer" 
                     data-index="${index}"
                     onclick="selectBatchSuggestion('${batch.batch_number.replace(/'/g, "\\'")}')"
                     onmouseenter="highlightBatchSuggestion(${index})">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-history text-info me-2"></i>
                            <strong>${batch.batch_number}</strong>
                        </div>
                        <small class="text-muted">æ•ˆæœŸ: ${batch.expiry_date}</small>
                    </div>
                    <small class="text-muted ms-3">ä¸Šæ¬¡å…¥åº«: ${batch.latest_entry}</small>
                </div>
            `).join('');
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
        }

        // æ›´æ–°æ‰¹è™Ÿå»ºè­°é¸æ“‡é«˜äº®
        function updateBatchSuggestionSelection() {
            const items = document.querySelectorAll('#batchSuggestions .suggestion-item');
            
            items.forEach((item, index) => {
                if (index === selectedBatchSuggestionIndex) {
                    item.classList.add('bg-primary', 'text-white');
                } else {
                    item.classList.remove('bg-primary', 'text-white');
                }
            });
        }

        // é¼ æ¨™æ‡¸åœé«˜äº®æ‰¹è™Ÿå»ºè­°
        function highlightBatchSuggestion(index) {
            selectedBatchSuggestionIndex = index;
            updateBatchSuggestionSelection();
        }

        // é¸æ“‡æ‰¹è™Ÿå»ºè­°
        function selectBatchSuggestion(batchNumber) {
            document.getElementById('reagentBatchNumber').value = batchNumber;
            hideBatchSuggestions();
            
            // è¼‰å…¥è©²æ‰¹è™Ÿçš„è©³ç´°è³‡æ–™
            const reagentName = document.getElementById('reagentName').value.trim();
            if (reagentName) {
                loadBatchExpiry(reagentName, batchNumber);
            }
        }

        // éš±è—æ‰¹è™Ÿå»ºè­°
        function hideBatchSuggestions() {
            const suggestionsDiv = document.getElementById('batchSuggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
            currentBatchSuggestions = [];
            selectedBatchSuggestionIndex = -1;
        }

        // æ¸…ç©ºæ•ˆæœŸæ¬„ä½
        function clearExpiryDate() {
            const expiryField = document.getElementById('expiryDate');
            expiryField.classList.remove('auto-filled');
            expiryField.readOnly = false;
        }

        // é¡¯ç¤ºè‡ªå‹•å¡«å……é€šçŸ¥
        function showAutoFillNotification(message) {
            // å‰µå»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show auto-fill-notification';
            notification.innerHTML = `
                <i class="fas fa-magic me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // æ’å…¥åˆ°è¡¨å–®é ‚éƒ¨
            const form = document.getElementById('entryForm');
            form.insertBefore(notification, form.firstChild);
            
            // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // é¡¯ç¤ºæ–°æ‰¹è™Ÿé€šçŸ¥
        function showNewBatchNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning alert-dismissible fade show';
            notification.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const form = document.getElementById('entryForm');
            form.insertBefore(notification, form.firstChild);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // é ç±¤åˆ‡æ›æ™‚é‡æ–°è¼‰å…¥è³‡æ–™ - ä½¿ç”¨å¤šç¨®æ–¹æ³•ç¢ºä¿å¯é æ€§
        function setupTabSwitching() {
            // æ–¹æ³•1: ç›´æ¥é»æ“Šäº‹ä»¶
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    const targetId = this.getAttribute('data-bs-target');
                    console.log('é»æ“Šé ç±¤:', this.id, 'ç›®æ¨™:', targetId);
                    
                    if (targetId === '#search-records') {
                        console.log('æº–å‚™è¼‰å…¥æœå°‹é ç±¤è³‡æ–™');
                        // å»¶é²ä¸€ä¸‹ç¢ºä¿é ç±¤åˆ‡æ›å®Œæˆå¾Œå†è¼‰å…¥è³‡æ–™
                        setTimeout(() => {
                            loadEntries();
                        }, 200);
                    }
                });
            });

            // æ–¹æ³•2: Bootstrapé ç±¤äº‹ä»¶
            document.addEventListener('shown.bs.tab', function(e) {
                console.log('Bootstrapé ç±¤äº‹ä»¶:', e.target.id);
                if (e.target.id === 'search-records-tab') {
                    console.log('Bootstrap: æœå°‹é ç±¤å·²é¡¯ç¤ºï¼Œè¼‰å…¥è³‡æ–™');
                    loadEntries();
                }
            });

            // æ–¹æ³•3: æ‰‹å‹•é ç±¤åˆ‡æ›å‡½æ•¸
            window.switchToSearchTab = function() {
                console.log('æ‰‹å‹•åˆ‡æ›åˆ°æœå°‹é ç±¤');
                const searchTab = document.getElementById('search-records-tab');
                const searchContent = document.getElementById('search-records');
                
                // ç§»é™¤æ‰€æœ‰activeé¡åˆ¥
                document.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(content => {
                    content.classList.remove('show', 'active');
                });
                
                // å•Ÿç”¨æœå°‹é ç±¤
                searchTab.classList.add('active');
                searchContent.classList.add('show', 'active');
                
                // è¼‰å…¥è³‡æ–™
                loadEntries();
            };
        }

        // åˆå§‹åŒ–é ç±¤åˆ‡æ›
        setupTabSwitching();

        // è¼‰å…¥å…¥åº«è¨˜éŒ„
        async function loadEntries() {
            try {
                const response = await fetch('/api/entries');
                allEntries = await response.json();
                displayEntries(allEntries);
            } catch (error) {
                console.error('è¼‰å…¥è¨˜éŒ„å¤±æ•—:', error);
            }
        }

                 // é¡¯ç¤ºå…¥åº«è¨˜éŒ„
         function displayEntries(entries) {
             const tbody = document.getElementById('entriesTableBody');
             tbody.innerHTML = '';

             // æ›´æ–°è¨˜éŒ„æ•¸é‡
             document.getElementById('recordCount').textContent = `å…± ${entries.length} ç­†è¨˜éŒ„`;

             if (entries.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</td></tr>';
        return;
    }
    
             entries.forEach(entry => {
                 const row = document.createElement('tr');

                 row.innerHTML = `
                     <td>${entry.reagent_name}</td>
                     <td><strong>${entry.reagent_batch_number}</strong></td>
                     <td>${entry.expiry_date}</td>
                     <td><span class="badge bg-primary">${entry.quantity}</span></td>
                     <td>${entry.unit}</td>
                     <td>${entry.supplier}</td>
                     <td>${entry.entry_date}</td>
                     <td>
                         <button class="btn btn-success btn-sm" onclick="showPrintQuantityModal(${entry.id}, '${entry.reagent_name}', ${entry.quantity}, '${entry.unit}')">
                             <i class="fas fa-print me-1"></i>åˆ—å°
                         </button>
                     </td>
                 `;
                 tbody.appendChild(row);
             });
         }





        // é¡¯ç¤ºåˆ—å°æ•¸é‡é¸æ“‡å™¨
        function showPrintQuantityModal(entryId, reagentName, originalQuantity, unit) {
            // è¨­å®šæ¨¡æ…‹æ¡†å…§å®¹
            document.getElementById('printReagentName').textContent = reagentName;
            document.getElementById('printOriginalQuantity').textContent = originalQuantity + ' ' + unit;
            document.getElementById('printQuantity').value = originalQuantity;
            
            // å„²å­˜entryIdä¾›ç¢ºèªåˆ—å°ä½¿ç”¨
            window.currentPrintEntryId = entryId;
            
            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            const modal = new bootstrap.Modal(document.getElementById('printQuantityModal'));
            modal.show();
        }

        // ç¢ºèªåˆ—å°
        async function confirmPrint() {
            const quantity = parseInt(document.getElementById('printQuantity').value);
            const printerType = document.getElementById('printPrinterType').value;
            const entryId = window.currentPrintEntryId;
            
            if (quantity > 0) {
                // é—œé–‰æ¨¡æ…‹æ¡†
                bootstrap.Modal.getInstance(document.getElementById('printQuantityModal')).hide();
                
                // åŸ·è¡Œåˆ—å°
                await directPrint(entryId, quantity, printerType);
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡');
            }
        }

                // ç›´æ¥åˆ—å°åˆ°é è¨­å°è¡¨æ©Ÿ
        async function directPrint(entryId, defaultQuantity, printerType = 'zpl') {
            try {
                const response = await fetch(`/api/print-direct/${entryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        quantity: defaultQuantity,
                        printer_type: printerType
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    alert('åˆ—å°å¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error('åˆ—å°å¤±æ•—:', error);
                alert('åˆ—å°å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // æ–°å¢å…¥åº«å¾Œç›´æ¥åˆ—å°æ¨™ç±¤ï¼ˆéœé»˜è™•ç†ï¼Œä¸é¡¯ç¤ºéŒ¯èª¤çµ¦ä½¿ç”¨è€…ï¼‰
        async function directPrintNewEntry(entryId, quantity, isNewBatch = false, printerType = 'zpl') {
            try {
                console.log('é–‹å§‹åˆ—å°æ–°å…¥åº«æ¨™ç±¤ï¼ŒID:', entryId, 'æ•¸é‡:', quantity, 'æ–°æ‰¹è™Ÿ:', isNewBatch, 'æ¨™ç±¤æ©Ÿé¡å‹:', printerType);
                
                const response = await fetch(`/api/print-direct/${entryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        quantity: quantity,
                        is_new_batch: isNewBatch,
                        printer_type: printerType
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    console.error('åˆ—å°å¤±æ•—ï¼š', result.message);
                    // ä¸é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ä½¿ç”¨è€…ï¼Œé¿å…å½±éŸ¿å…¥åº«æµç¨‹
        } else {
                    console.log('æ¨™ç±¤åˆ—å°æˆåŠŸ');
                }
            } catch (error) {
                console.error('åˆ—å°éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
                // éœé»˜è™•ç†éŒ¯èª¤ï¼Œä¸å½±éŸ¿å…¥åº«æˆåŠŸ
            }
        }

        // é¡¯ç¤ºæˆåŠŸæç¤º
        function showSuccessModal(message) {
            document.getElementById('successMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        }

         // è¡¨å–®æäº¤è™•ç†
         document.getElementById('entryForm').addEventListener('submit', async function(e) {
             e.preventDefault();

             // é©—è­‰è¡¨å–®
             if (!validateForm()) {
                 return;
             }

             const formData = {
                 reagent_name: document.getElementById('reagentName').value,
                 reagent_batch_number: document.getElementById('reagentBatchNumber').value,
                 expiry_date: document.getElementById('expiryDate').value,
                 quantity: parseInt(document.getElementById('quantity').value),
                 unit: document.getElementById('unit').value === 'å…¶ä»–' ? document.getElementById('unitOther').value : document.getElementById('unit').value,
                 supplier: document.getElementById('supplier').value === 'å…¶ä»–' ? document.getElementById('supplierOther').value : document.getElementById('supplier').value,
                 printer_type: document.getElementById('printerType').value
             };

             try {
                 const response = await fetch('/api/entries', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify(formData)
                 });

                 const result = await response.json();
                 
                                   if (result.success) {
                      // ä¸€èˆ¬å…¥åº«æˆåŠŸ
                   
                   // å…¥åº«æˆåŠŸå¾Œï¼Œç›´æ¥åˆ—å°æ¨™ç±¤
                   if (result.entry_id) {
                       await directPrintNewEntry(result.entry_id, formData.quantity, result.is_new_batch || false, formData.printer_type);
                   }
                      
                      // æ¸…ç©ºè¡¨å–®
                      document.getElementById('entryForm').reset();
                      
                      // é‡æ–°è¼‰å…¥è¨˜éŒ„
                      loadEntries();
                    
                    // ä¸é¡¯ç¤ºæˆåŠŸå°è©±è¦–çª—ï¼Œéœé»˜è™•ç†
                  } else if (result.is_new_batch) {
                     // æª¢æ¸¬åˆ°æ–°æ‰¹è™Ÿï¼Œé¡¯ç¤ºç¢ºèªæ¨¡æ…‹æ¡†
                     showNewBatchModal(result.message, result.data);
            } else {
                     // å…¶ä»–éŒ¯èª¤
                     alert('æ“ä½œå¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                 }
             } catch (error) {
                 console.error('å„²å­˜å¤±æ•—:', error);
                 alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
             }
         });

         // é¡¯ç¤ºæ–°æ‰¹è™Ÿç¢ºèªæ¨¡æ…‹æ¡†
         function showNewBatchModal(message, data) {
             // è¨­ç½®æ¨¡æ…‹æ¡†å…§å®¹
             document.getElementById('newBatchMessage').textContent = message;
             document.getElementById('previewReagentName').textContent = data.reagent_name;
             document.getElementById('previewBatchNumber').textContent = data.reagent_batch_number;
             document.getElementById('previewExpiryDate').textContent = data.expiry_date;
             document.getElementById('previewQuantity').textContent = data.quantity;
             document.getElementById('previewUnit').textContent = data.unit;
             document.getElementById('previewSupplier').textContent = data.supplier;
             
             // å„²å­˜è³‡æ–™ä¾›ç¢ºèªæ™‚ä½¿ç”¨
             window.pendingEntryData = data;
             
             // é¡¯ç¤ºæ¨¡æ…‹æ¡†
             const modal = new bootstrap.Modal(document.getElementById('newBatchModal'));
             modal.show();
         }

         // ç¢ºèªæ–°æ‰¹è™Ÿå…¥åº«
         async function confirmNewBatchEntry() {
             if (!window.pendingEntryData) {
                 alert('æ²’æœ‰å¾…ç¢ºèªçš„å…¥åº«è³‡æ–™');
                 return;
             }

             try {
                 // æ·»åŠ æ¨™ç±¤æ©Ÿé¡å‹åˆ°å¾…ç¢ºèªè³‡æ–™
                 const dataWithPrinterType = {
                     ...window.pendingEntryData,
                     printer_type: document.getElementById('printerType').value
                 };
                 
                 const response = await fetch('/api/confirm-entry', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify(dataWithPrinterType)
                 });

                 const result = await response.json();
                 
                                   if (result.success) {
                      // å…¥åº«æˆåŠŸ
                   
                   // å…¥åº«æˆåŠŸå¾Œï¼Œç›´æ¥åˆ—å°æ¨™ç±¤ï¼ˆæ–°æ‰¹è™Ÿï¼‰
                   if (result.entry_id) {
                       const printerType = document.getElementById('printerType').value;
                       await directPrintNewEntry(result.entry_id, window.pendingEntryData.quantity, result.is_new_batch || true, printerType);
                   }
                      
                      // æ¸…ç©ºè¡¨å–®
                      document.getElementById('entryForm').reset();
                      
                      // é‡æ–°è¼‰å…¥è¨˜éŒ„
                      loadEntries();
                      
                      // é—œé–‰æ–°æ‰¹è™Ÿç¢ºèªæ¨¡æ…‹æ¡†
                      bootstrap.Modal.getInstance(document.getElementById('newBatchModal')).hide();
                      
                      // æ¸…é™¤å¾…ç¢ºèªè³‡æ–™
                      window.pendingEntryData = null;
                    
                    // ä¸é¡¯ç¤ºæˆåŠŸå°è©±è¦–çª—ï¼Œéœé»˜è™•ç†
            } else {
                     alert('ç¢ºèªå…¥åº«å¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                 }
             } catch (error) {
                 console.error('ç¢ºèªå…¥åº«å¤±æ•—:', error);
                 alert('ç¢ºèªå…¥åº«å¤±æ•—ï¼Œè«‹é‡è©¦');
             }
         }



         // è™•ç†å–®ä½é¸æ“‡è®Šæ›´
         function handleUnitChange() {
             const unitSelect = document.getElementById('unit');
             const unitOther = document.getElementById('unitOther');
             
             if (unitSelect.value === 'å…¶ä»–') {
                 unitOther.style.display = 'block';
                 unitOther.required = true;
                 unitOther.focus();
             } else {
                 unitOther.style.display = 'none';
                 unitOther.required = false;
                 unitOther.value = '';
             }
         }

         // è™•ç†ä¾›æ‡‰å•†é¸æ“‡è®Šæ›´
         function handleSupplierChange() {
             const supplierSelect = document.getElementById('supplier');
             const supplierOther = document.getElementById('supplierOther');
             
             if (supplierSelect.value === 'å…¶ä»–') {
                 supplierOther.style.display = 'block';
                 supplierOther.required = true;
                 supplierOther.focus();
             } else {
                 supplierOther.style.display = 'none';
                 supplierOther.required = false;
                 supplierOther.value = '';
             }
         }

         // è¡¨å–®é©—è­‰
         function validateForm() {
             const unitSelect = document.getElementById('unit');
             const unitOther = document.getElementById('unitOther');
             const supplierSelect = document.getElementById('supplier');
             const supplierOther = document.getElementById('supplierOther');

             // é©—è­‰å–®ä½
             if (unitSelect.value === 'å…¶ä»–' && !unitOther.value.trim()) {
                 alert('è«‹è¼¸å…¥å…¶ä»–å–®ä½');
                 unitOther.focus();
                 return false;
             }

             // é©—è­‰ä¾›æ‡‰å•†
             if (supplierSelect.value === 'å…¶ä»–' && !supplierOther.value.trim()) {
                 alert('è«‹è¼¸å…¥å…¶ä»–ä¾›æ‡‰å•†');
                 supplierOther.focus();
                 return false;
             }

             return true;
         }

         // å¥—ç”¨ç¯©é¸å™¨
         function applyFilters() {
             const filterName = document.getElementById('filterName').value.trim();
            const filterBatch = document.getElementById('filterBatch').value.trim();
             const filterSupplier = document.getElementById('filterSupplier').value;
             const filterDateFrom = document.getElementById('filterDateFrom').value;
             const filterDateTo = document.getElementById('filterDateTo').value;

             let filteredEntries = allEntries.filter(entry => {
                 // åç¨±ç¯©é¸
                 if (filterName && !entry.reagent_name.toLowerCase().includes(filterName.toLowerCase())) {
                     return false;
                 }

                // æ‰¹è™Ÿç¯©é¸
                if (filterBatch && !entry.reagent_batch_number.toLowerCase().includes(filterBatch.toLowerCase())) {
                    return false;
                }

                 // ä¾›æ‡‰å•†ç¯©é¸
                 if (filterSupplier && entry.supplier !== filterSupplier) {
                     return false;
                 }

                 // æ—¥æœŸç¯„åœç¯©é¸
                 if (filterDateFrom || filterDateTo) {
                     const entryDate = new Date(entry.entry_date.split(' ')[0]); // åªå–æ—¥æœŸéƒ¨åˆ†
                     
                     if (filterDateFrom && entryDate < new Date(filterDateFrom)) {
                         return false;
                     }
                     
                     if (filterDateTo && entryDate > new Date(filterDateTo)) {
                         return false;
                     }
                 }

                 return true;
             });

             displayEntries(filteredEntries);
         }

         // æ¸…é™¤ç¯©é¸å™¨
         function clearFilters() {
             document.getElementById('filterName').value = '';
            document.getElementById('filterBatch').value = '';
             document.getElementById('filterSupplier').value = '';
             document.getElementById('filterDateFrom').value = '';
             document.getElementById('filterDateTo').value = '';
             
             // é‡æ–°é¡¯ç¤ºæ‰€æœ‰è¨˜éŒ„
             displayEntries(allEntries);
         }

         // åŒ¯å‡ºCSVåŠŸèƒ½
         function exportToCSV() {
             const currentEntries = allEntries;
             if (currentEntries.length === 0) {
                 alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
        return;
    }
    
             // CSVæ¨™é¡Œ
             const headers = ['è©¦åŠ‘åç¨±', 'è©¦åŠ‘æ‰¹è™Ÿ', 'ç©©å®šæ•ˆæœŸ', 'æ•¸é‡', 'å–®ä½', 'ä¾›æ‡‰å•†', 'å…¥åº«æ—¥æœŸ'];
             
             // CSVå…§å®¹
             const csvContent = [
                 headers.join(','),
                 ...currentEntries.map(entry => [
                     entry.reagent_name,
                     entry.reagent_batch_number,
                     entry.expiry_date,
                     entry.quantity,
                     entry.unit,
                     entry.supplier,
                     entry.entry_date
                 ].join(','))
             ].join('\n');

             // å‰µå»ºä¸‹è¼‰é€£çµ
             const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement('a');
             const url = URL.createObjectURL(blob);
             link.setAttribute('href', url);
             link.setAttribute('download', `è©¦åŠ‘å…¥åº«ç´€éŒ„_${new Date().toISOString().split('T')[0]}.csv`);
             link.style.visibility = 'hidden';
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
         }

         // é¡¯ç¤ºåŒ¯å…¥æ¨¡æ…‹æ¡†
         function showImportModal() {
             // é‡ç½®è¡¨å–®
             document.getElementById('csvFile').value = '';
             document.getElementById('importBtn').disabled = true;
             document.getElementById('importProgress').classList.add('d-none');
             document.getElementById('importResult').classList.add('d-none');
             
             // é¡¯ç¤ºæ¨¡æ…‹æ¡†
             const importModal = new bootstrap.Modal(document.getElementById('importModal'));
             importModal.show();
         }

         // é©—è­‰æª”æ¡ˆ
         function validateFile() {
             const fileInput = document.getElementById('csvFile');
             const importBtn = document.getElementById('importBtn');
             
             if (fileInput.files.length > 0) {
                 const file = fileInput.files[0];
                 
                 // æª¢æŸ¥æª”æ¡ˆé¡å‹
                 if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                     importBtn.disabled = false;
                 } else {
                     alert('è«‹é¸æ“‡CSVæª”æ¡ˆ');
                     fileInput.value = '';
                     importBtn.disabled = true;
                 }
             } else {
                 importBtn.disabled = true;
             }
         }

         // ä¸‹è¼‰CSVç¯„æœ¬
         function downloadTemplate() {
             const headers = ['è©¦åŠ‘åç¨±', 'è©¦åŠ‘æ‰¹è™Ÿ', 'ç©©å®šæ•ˆæœŸ', 'æ•¸é‡', 'å–®ä½', 'ä¾›æ‡‰å•†', 'å…¥åº«æ—¥æœŸ'];
             const sampleData = [
                 ['GOT', 'GOT001', '2025-12-31', '10', 'çµ„', 'äºåŸ¹', '2025-08-22 09:00:00'],
                 ['GPT', 'GPT001', '2025-12-31', '5', 'çµ„', 'ç¾…æ°', '2025-08-22 10:00:00']
             ];
             
             const csvContent = [
                 headers.join(','),
                 ...sampleData.map(row => row.join(','))
             ].join('\n');
             
             const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement('a');
             const url = URL.createObjectURL(blob);
             link.setAttribute('href', url);
             link.setAttribute('download', 'è©¦åŠ‘å…¥åº«ç´€éŒ„_CSVç¯„æœ¬.csv');
             link.style.visibility = 'hidden';
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
         }

         // åŒ¯å…¥CSVæª”æ¡ˆ
         async function importCSV() {
             const fileInput = document.getElementById('csvFile');
             const importBtn = document.getElementById('importBtn');
             const importProgress = document.getElementById('importProgress');
             const importResult = document.getElementById('importResult');
             
             if (fileInput.files.length === 0) {
                 alert('è«‹é¸æ“‡è¦åŒ¯å…¥çš„CSVæª”æ¡ˆ');
                 return;
             }
             
             const file = fileInput.files[0];
             
             // é¡¯ç¤ºé€²åº¦æ¢
             importProgress.classList.remove('d-none');
             importBtn.disabled = true;
             
             try {
                 // å»ºç«‹FormData
                 const formData = new FormData();
                 formData.append('file', file);
                 
                 // ç™¼é€è«‹æ±‚
                 const response = await fetch('/api/import-csv', {
                     method: 'POST',
                     body: formData
                 });
                 
                 const result = await response.json();
                 
                 // éš±è—é€²åº¦æ¢
                 importProgress.classList.add('d-none');
                 
                 if (result.success) {
                     // é¡¯ç¤ºæˆåŠŸçµæœ
                     importResult.classList.remove('d-none');
                     importResult.innerHTML = `
                         <div class="alert alert-success">
                             <h6 class="alert-heading">åŒ¯å…¥æˆåŠŸï¼</h6>
                             <p class="mb-0">${result.message}</p>
                             <hr>
                             <p class="mb-0"><strong>æˆåŠŸè™•ç†ï¼š</strong>${result.success_count} ç­†è¨˜éŒ„</p>
                             <p class="mb-0"><strong>å¤±æ•—è¨˜éŒ„ï¼š</strong>${result.error_count} ç­†</p>
                        </div>
                     `;
                     
                     // å¦‚æœæœ‰éŒ¯èª¤ï¼Œé¡¯ç¤ºéŒ¯èª¤è©³æƒ…
                     if (result.errors && result.errors.length > 0) {
                         importResult.innerHTML += `
                             <div class="alert alert-warning">
                                 <h6 class="alert-heading">éŒ¯èª¤è©³æƒ…ï¼š</h6>
                                 <ul class="mb-0">
                                     ${result.errors.map(error => `<li>${error}</li>`).join('')}
                                 </ul>
                    </div>
                         `;
                     }
                     
                     // é‡æ–°è¼‰å…¥è³‡æ–™
                     await loadEntries();
                     
                     // 3ç§’å¾Œè‡ªå‹•éš±è—çµæœ
                     setTimeout(() => {
                         importResult.classList.add('d-none');
                     }, 3000);
                     
                 } else {
                     // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                     importResult.classList.remove('d-none');
                     importResult.innerHTML = `
                         <div class="alert alert-danger">
                             <h6 class="alert-heading">åŒ¯å…¥å¤±æ•—</h6>
                             <p class="mb-0">${result.error}</p>
                         </div>
                     `;
                 }
                 
                 // é‡æ–°å•Ÿç”¨åŒ¯å…¥æŒ‰éˆ•
                 importBtn.disabled = false;
                 
             } catch (error) {
                 console.error('åŒ¯å…¥å¤±æ•—:', error);
                 
                 // éš±è—é€²åº¦æ¢
                 importProgress.classList.add('d-none');
                 
                 // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                 importResult.classList.remove('d-none');
                 importResult.innerHTML = `
                     <div class="alert alert-danger">
                         <h6 class="alert-heading">åŒ¯å…¥å¤±æ•—</h6>
                         <p class="mb-0">ç¶²è·¯éŒ¯èª¤æˆ–ä¼ºæœå™¨å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦</p>
                     </div>
                 `;
                 
                 // é‡æ–°å•Ÿç”¨åŒ¯å…¥æŒ‰éˆ•
                 importBtn.disabled = false;
             }
}
</script>
</body>
</html>
